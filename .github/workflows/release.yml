name: Release Build

on:
  release:
    types: [created]

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            os_name: linux
            artifact_name: linux-x64
            build_type: Release
          - os: macos-15
            os_name: macos
            artifact_name: macos-x64
            build_type: Release
            arch: x86_64
          - os: macos-latest
            os_name: macos
            artifact_name: macos-arm64
            build_type: Release
            arch: arm64
          - os: windows-2022
            os_name: windows
            artifact_name: windows-x64
            build_type: Release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for version detection
    
    - name: Extract version from tag
      id: version
      shell: bash
      run: |
        if [[ "${{ github.event.release.tag_name }}" != "" ]]; then
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
        elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
        else
          VERSION="0.0.0-dev"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Install dependencies (Linux)
      if: matrix.os_name == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libxext-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          libwayland-dev \
          wayland-protocols \
          extra-cmake-modules \
          libgl-dev \
          libglvnd-dev
    
    - name: Install Vulkan SDK (Linux)
      if: matrix.os_name == 'linux'
      run: |
        wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
        sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list
        sudo apt-get update
        sudo apt-get install -y \
          vulkan-tools \
          vulkan-validationlayers-dev \
          vulkan-headers \
          libvulkan-dev \
          libvulkan1 \
          vulkan-validationlayers \
          vulkan-utils
    
    - name: Install dependencies (macOS)
      if: matrix.os_name == 'macos'
      run: |
        brew install cmake
    
    - name: Install Vulkan SDK (macOS)
      if: matrix.os_name == 'macos'
      run: |
        # Get latest version
        VULKAN_VERSION=$(curl -s https://vulkan.lunarg.com/sdk/latest/mac.txt)
        echo "VULKAN_VERSION=$VULKAN_VERSION" >> $GITHUB_ENV
        echo "Installing Vulkan SDK version $VULKAN_VERSION"
        
        # Download and extract
        curl -L -o vulkan_sdk.zip "https://sdk.lunarg.com/sdk/download/${VULKAN_VERSION}/mac/vulkan_sdk.zip?Human=true"
        unzip -q vulkan_sdk.zip
        
        # Extract SDK from .app bundle
        APP_NAME="vulkansdk-macOS-${VULKAN_VERSION}.app"
        if [ -d "$APP_NAME" ]; then
          # Remove quarantine attribute to allow execution
          xattr -cr "$APP_NAME" || true
          
          # Create installation directory
          INSTALL_DIR="$HOME/VulkanSDK/${VULKAN_VERSION}"
          mkdir -p "$INSTALL_DIR"
          
          # Run the installer in non-interactive mode
          # The installer extracts to ~/VulkanSDK/${VULKAN_VERSION}/macOS
          # Try running the installer with various flag combinations
          INSTALLER_CMD="$APP_NAME/Contents/MacOS/vulkansdk-macOS-${VULKAN_VERSION}"
          
          # Try different installer command variations
          "$INSTALLER_CMD" --root "$HOME/VulkanSDK" --accept-licenses --default-answer --confirm-command install 2>&1 || \
          "$INSTALLER_CMD" --root "$HOME/VulkanSDK" --accept-licenses install 2>&1 || \
          "$INSTALLER_CMD" install --root "$HOME/VulkanSDK" 2>&1 || {
            echo "Installer failed, trying alternative extraction method..."
            # Alternative: try to extract installer.dat directly
            cd "$APP_NAME/Contents/Resources"
            # installer.dat is typically a xar archive
            if command -v xar &> /dev/null; then
              xar -xf installer.dat 2>/dev/null || true
            fi
            # Look for payload directory
            if [ -d "payload" ]; then
              cp -r payload/* "$INSTALL_DIR/" 2>/dev/null || true
            fi
            # Also check for other common extraction locations
            if [ -d "macOS" ]; then
              cp -r macOS/* "$INSTALL_DIR/" 2>/dev/null || true
            fi
            cd - > /dev/null
          }
          
          # Find the actual SDK directory (usually in macOS subdirectory)
          if [ -d "$INSTALL_DIR/macOS" ]; then
            SDK_DIR="$INSTALL_DIR/macOS"
          elif [ -d "$INSTALL_DIR" ]; then
            SDK_DIR="$INSTALL_DIR"
          else
            # Try to find any VulkanSDK directory
            SDK_DIR=$(find "$HOME/VulkanSDK" -type d -name "macOS" | head -1)
            if [ -z "$SDK_DIR" ]; then
              SDK_DIR=$(find "$HOME/VulkanSDK" -maxdepth 2 -type d | grep -E "${VULKAN_VERSION}" | head -1)
            fi
          fi
          
          if [ -n "$SDK_DIR" ] && [ -d "$SDK_DIR" ]; then
            echo "VULKAN_SDK=$SDK_DIR" >> $GITHUB_ENV
            echo "Vulkan SDK found at: $SDK_DIR"
            ls -la "$SDK_DIR" || true
          else
            echo "Error: Could not find Vulkan SDK installation directory"
            echo "Contents of $HOME/VulkanSDK:"
            ls -la "$HOME/VulkanSDK" || true
            exit 1
          fi
        else
          echo "Error: Could not find $APP_NAME"
          exit 1
        fi
    
    - name: Install Vulkan SDK (Windows)
      if: matrix.os_name == 'windows'
      uses: humbletim/install-vulkan-sdk@v1.2
      with:
        version: latest
        cache: true
    
    - name: Install dependencies (Windows)
      if: matrix.os_name == 'windows'
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
    
    - name: Configure CMake
      shell: bash
      run: |
        # Debug: Print environment variables
        echo "VULKAN_SDK=$VULKAN_SDK"
        if [[ "${{ matrix.os_name }}" == "windows" ]]; then
          # On Windows, the action sets VULKAN_SDK in the environment
          # Ensure it's available and convert to Windows path format if needed
          if [ -n "$VULKAN_SDK" ]; then
            export VULKAN_SDK
            echo "VULKAN_SDK is set to: $VULKAN_SDK"
            # Verify the directory exists
            if [ -d "$VULKAN_SDK" ]; then
              echo "VULKAN_SDK directory exists"
              ls -la "$VULKAN_SDK" || true
            else
              echo "Warning: VULKAN_SDK directory does not exist: $VULKAN_SDK"
            fi
          else
            echo "Error: VULKAN_SDK is not set"
            exit 1
          fi
        fi
        
        if [[ "${{ matrix.os_name }}" == "macos" && "${{ matrix.arch }}" != "" ]]; then
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DVROOM_VERSION=${{ steps.version.outputs.VERSION }} \
            -DVROOM_BUILD_VROOM_EDITOR=ON \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DVULKAN_SDK="$VULKAN_SDK"
        elif [[ "${{ matrix.os_name }}" == "windows" ]]; then
          # On Windows, explicitly pass VULKAN_SDK to CMake
          # Convert path separators if needed (bash on Windows might use /)
          # CMake handles both / and \ on Windows, but ensure paths are correct
          VK_SDK=$(echo "$VULKAN_SDK" | sed 's|\\|/|g')
          VK_INCLUDE="$VK_SDK/Include"
          VK_LIB="$VK_SDK/Lib/vulkan-1.lib"
          
          echo "Using Vulkan SDK paths:"
          echo "  VULKAN_SDK: $VK_SDK"
          echo "  Include: $VK_INCLUDE"
          echo "  Library: $VK_LIB"
          
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DVROOM_VERSION=${{ steps.version.outputs.VERSION }} \
            -DVROOM_BUILD_VROOM_EDITOR=ON \
            -DVULKAN_SDK="$VK_SDK" \
            -DVulkan_INCLUDE_DIR="$VK_INCLUDE" \
            -DVulkan_LIBRARY="$VK_LIB"
        else
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DVROOM_VERSION=${{ steps.version.outputs.VERSION }} \
            -DVROOM_BUILD_VROOM_EDITOR=ON
        fi
    
    - name: Build
      run: |
        cmake --build build --config ${{ matrix.build_type }} -j${{ matrix.os_name == 'windows' && '4' || '$(nproc)' }}
    
    - name: Package (Linux)
      if: matrix.os_name == 'linux'
      run: |
        mkdir -p release
        cp build/vroom_editor/vroom_editor release/
        cp -r build/vroom_editor/assets release/ 2>/dev/null || true
        tar -czf vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.tar.gz -C release .
    
    - name: Package (macOS)
      if: matrix.os_name == 'macos'
      run: |
        mkdir -p release
        cp build/vroom_editor/vroom_editor release/vroom_editor
        cp -r build/vroom_editor/assets release/ 2>/dev/null || true
        tar -czf vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.tar.gz -C release .
    
    - name: Package (Windows)
      if: matrix.os_name == 'windows'
      run: |
        mkdir release
        copy build\vroom_editor\${{ matrix.build_type }}\vroom_editor.exe release\
        xcopy /E /I build\vroom_editor\${{ matrix.build_type }}\assets release\assets 2>nul || echo "No assets directory"
        powershell Compress-Archive -Path release\* -DestinationPath vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip
    
    - name: Determine artifact file
      id: artifact
      shell: bash
      run: |
        if [[ "${{ matrix.os_name }}" == "windows" ]]; then
          echo "FILE=vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip" >> $GITHUB_OUTPUT
        else
          echo "FILE=vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.tar.gz" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}
        path: ${{ steps.artifact.outputs.FILE }}
        retention-days: 90
    
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.artifact.outputs.FILE }}
        draft: false
        prerelease: ${{ contains(github.event.release.tag_name, 'alpha') || contains(github.event.release.tag_name, 'beta') || contains(github.event.release.tag_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
