name: Release Build

on:
  release:
    types: [created]

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            os_name: linux
            artifact_name: linux-x64
            build_type: Release
          - os: macos-15
            os_name: macos
            artifact_name: macos-x64
            build_type: Release
            arch: x86_64
          - os: macos-latest
            os_name: macos
            artifact_name: macos-arm64
            build_type: Release
            arch: arm64
          - os: windows-2022
            os_name: windows
            artifact_name: windows-x64
            build_type: Release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for version detection
    
    - name: Extract version from tag
      id: version
      shell: bash
      run: |
        if [[ "${{ github.event.release.tag_name }}" != "" ]]; then
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
        elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
        else
          VERSION="0.0.0-dev"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Install dependencies (Linux)
      if: matrix.os_name == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libxext-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          libwayland-dev \
          wayland-protocols \
          extra-cmake-modules \
          libgl-dev \
          libglvnd-dev
    
    - name: Install Vulkan SDK (Linux)
      if: matrix.os_name == 'linux'
      run: |
        wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
        sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list
        sudo apt-get update
        sudo apt-get install -y \
          vulkan-tools \
          vulkan-validationlayers-dev \
          vulkan-headers \
          libvulkan-dev \
          libvulkan1 \
          vulkan-validationlayers \
          vulkan-utils
    
    - name: Install dependencies (macOS)
      if: matrix.os_name == 'macos'
      run: |
        brew install cmake
    
    - name: Install Vulkan SDK (macOS)
      if: matrix.os_name == 'macos'
      run: |
        # Get latest version
        VULKAN_VERSION=$(curl -s https://vulkan.lunarg.com/sdk/latest/mac.txt)
        echo "VULKAN_VERSION=$VULKAN_VERSION" >> $GITHUB_ENV
        echo "Installing Vulkan SDK version $VULKAN_VERSION"
        
        # Download and extract
        curl -L -o vulkan_sdk.zip "https://sdk.lunarg.com/sdk/download/${VULKAN_VERSION}/mac/vulkan_sdk.zip?Human=true"
        unzip -q vulkan_sdk.zip
        
        # Extract SDK from .app bundle
        APP_NAME="vulkansdk-macOS-${VULKAN_VERSION}.app"
        if [ -d "$APP_NAME" ]; then
          # Remove quarantine attribute to allow execution
          xattr -cr "$APP_NAME" || true
          
          # Clean up previous installation attempt to avoid "directory not empty" errors
          rm -rf "$HOME/VulkanSDK"

          # Define expected installation directory (but don't create it manually)
          INSTALL_DIR="$HOME/VulkanSDK/${VULKAN_VERSION}"
          
          # Run the installer in non-interactive mode
          # The installer extracts to ~/VulkanSDK/${VULKAN_VERSION}/macOS
          # Try running the installer with various flag combinations
          INSTALLER_CMD="$APP_NAME/Contents/MacOS/vulkansdk-macOS-${VULKAN_VERSION}"
          
          # Try different installer command variations
          "$INSTALLER_CMD" --root "$HOME/VulkanSDK" --accept-licenses --default-answer --confirm-command install 2>&1 || \
          "$INSTALLER_CMD" --root "$HOME/VulkanSDK" --accept-licenses install 2>&1 || \
          "$INSTALLER_CMD" install --root "$HOME/VulkanSDK" 2>&1 || {
            echo "Installer failed, trying alternative extraction method..."
            # Alternative: try to extract installer.dat directly
            cd "$APP_NAME/Contents/Resources"
            # installer.dat is typically a xar archive
            if command -v xar &> /dev/null; then
              xar -xf installer.dat 2>/dev/null || true
            fi
            # Look for payload directory
            if [ -d "payload" ]; then
              cp -r payload/* "$INSTALL_DIR/" 2>/dev/null || true
            fi
            # Also check for other common extraction locations
            if [ -d "macOS" ]; then
              cp -r macOS/* "$INSTALL_DIR/" 2>/dev/null || true
            fi
            cd - > /dev/null
          }
          
          # Find the actual SDK directory (usually in macOS subdirectory)
          # The installer typically creates: ~/VulkanSDK/${VULKAN_VERSION}/macOS
          if [ -d "$INSTALL_DIR/macOS" ]; then
            SDK_DIR="$INSTALL_DIR/macOS"
          elif [ -d "$INSTALL_DIR" ] && [ -d "$INSTALL_DIR/include" ] && [ -d "$INSTALL_DIR/lib" ]; then
            # SDK is directly in the version directory
            SDK_DIR="$INSTALL_DIR"
          else
            # Try to find any VulkanSDK directory with include/lib
            SDK_DIR=$(find "$HOME/VulkanSDK" -type d -name "macOS" | head -1)
            if [ -z "$SDK_DIR" ] || [ ! -d "$SDK_DIR/include" ]; then
              # Look for directory with include and lib subdirectories
              SDK_DIR=$(find "$HOME/VulkanSDK" -type d -path "*/include" -o -path "*/lib" | head -1 | sed 's|/include.*||' | sed 's|/lib.*||')
            fi
          fi
          
          # Verify SDK directory has required components
          if [ -n "$SDK_DIR" ] && [ -d "$SDK_DIR" ]; then
            echo "Checking SDK directory: $SDK_DIR"
            ls -la "$SDK_DIR" || true
            
            # Check for include and lib directories
            if [ -d "$SDK_DIR/include" ] && [ -d "$SDK_DIR/lib" ]; then
              echo "VULKAN_SDK=$SDK_DIR" >> $GITHUB_ENV
              echo "Vulkan SDK found at: $SDK_DIR"
              echo "Include directory: $SDK_DIR/include"
              echo "Lib directory: $SDK_DIR/lib"
              ls -la "$SDK_DIR/include" | head -5 || true
              ls -la "$SDK_DIR/lib" | head -5 || true
            else
              echo "Warning: SDK directory found but missing include/lib subdirectories"
              echo "Contents of $SDK_DIR:"
              ls -la "$SDK_DIR" || true
              # Try parent directory if this one doesn't have include/lib
              PARENT_DIR=$(dirname "$SDK_DIR")
              if [ -d "$PARENT_DIR/macOS" ]; then
                SDK_DIR="$PARENT_DIR/macOS"
                echo "Trying parent macOS directory: $SDK_DIR"
                if [ -d "$SDK_DIR/include" ] && [ -d "$SDK_DIR/lib" ]; then
                  echo "VULKAN_SDK=$SDK_DIR" >> $GITHUB_ENV
                  echo "Vulkan SDK found at: $SDK_DIR"
                else
                  echo "Error: Could not find valid Vulkan SDK installation"
                  exit 1
                fi
              else
                echo "Error: Could not find valid Vulkan SDK installation"
                exit 1
              fi
            fi
          else
            echo "Error: Could not find Vulkan SDK installation directory"
            echo "Contents of $HOME/VulkanSDK:"
            ls -la "$HOME/VulkanSDK" || true
            if [ -d "$HOME/VulkanSDK" ]; then
              find "$HOME/VulkanSDK" -type d -maxdepth 3 | head -20 || true
            fi
            exit 1
          fi
        else
          echo "Error: Could not find $APP_NAME"
          exit 1
        fi
    
    - name: Install Vulkan SDK (Windows)
      if: matrix.os_name == 'windows'
      id: install_vulkan
      uses: humbletim/install-vulkan-sdk@v1.2
      with:
        version: 1.3.268.0  # Pin to a known working version for now
        cache: true
    
    - name: Verify Vulkan SDK installation (Windows)
      if: matrix.os_name == 'windows'
      shell: bash
      run: |
        echo "Checking VULKAN_SDK environment variable:"
        echo "VULKAN_SDK=$VULKAN_SDK"
        
        # The action should set VULKAN_SDK, but verify it exists
        VK_SDK_BASE=""
        if [ -n "$VULKAN_SDK" ]; then
          VK_SDK_BASE=$(echo "$VULKAN_SDK" | sed 's|\\|/|g')
        fi
        
        # Check if base path exists
        if [ -n "$VK_SDK_BASE" ] && [ -d "$VK_SDK_BASE" ]; then
          echo "VULKAN_SDK base path exists: $VK_SDK_BASE"
          
          # Check if Include directory exists directly
          if [ -d "$VK_SDK_BASE/Include" ] || [ -d "$VK_SDK_BASE/include" ]; then
            echo "Vulkan SDK found at: $VK_SDK_BASE"
            echo "VULKAN_SDK=$VK_SDK_BASE" >> $GITHUB_ENV
          else
            # Check for versioned subdirectories
            echo "Checking for versioned subdirectories..."
            VK_SDK=$(find "$VK_SDK_BASE" -maxdepth 1 -type d | grep -E "[0-9]+\.[0-9]+\.[0-9]+" | sort -V | tail -1 || true)
            if [ -n "$VK_SDK" ] && [ -d "$VK_SDK" ]; then
              if [ -d "$VK_SDK/Include" ] || [ -d "$VK_SDK/include" ]; then
                echo "Found Vulkan SDK in versioned subdirectory: $VK_SDK"
                echo "VULKAN_SDK=$VK_SDK" >> $GITHUB_ENV
              else
                echo "Warning: Versioned directory found but no Include directory"
              fi
            else
              echo "Warning: No versioned subdirectory found"
              echo "Contents of $VK_SDK_BASE:"
              ls -la "$VK_SDK_BASE" || true
            fi
          fi
        else
          echo "Warning: VULKAN_SDK path does not exist: $VK_SDK_BASE"
          echo "Trying to find Vulkan SDK in common locations..."
          
          # Try to find it in the workspace or common locations
          if [ -d "$GITHUB_WORKSPACE/VULKAN_SDK" ]; then
            VK_SDK_BASE="$GITHUB_WORKSPACE/VULKAN_SDK"
          elif [ -d "/c/VulkanSDK" ]; then
            # Find latest version
            VK_SDK_BASE=$(find /c/VulkanSDK -maxdepth 1 -type d | grep -E "[0-9]+\.[0-9]+\.[0-9]+" | sort -V | tail -1 || true)
          fi
          
          if [ -n "$VK_SDK_BASE" ] && [ -d "$VK_SDK_BASE" ]; then
            if [ -d "$VK_SDK_BASE/Include" ] || [ -d "$VK_SDK_BASE/include" ]; then
              echo "Found Vulkan SDK at: $VK_SDK_BASE"
              echo "VULKAN_SDK=$VK_SDK_BASE" >> $GITHUB_ENV
            fi
          fi
        fi
        
        # Final verification - read from GITHUB_ENV if we set it, otherwise use original
        if [ -f "$GITHUB_ENV" ]; then
          # Source the env file to get our updated value
          set -a
          source "$GITHUB_ENV" 2>/dev/null || true
          set +a
        fi
        
        # Use the value we found or the original
        VK_SDK_FINAL="$VULKAN_SDK"
        if [ -n "$VK_SDK" ]; then
          VK_SDK_FINAL="$VK_SDK"
        fi
        
        if [ -n "$VK_SDK_FINAL" ]; then
          VK_SDK_FINAL=$(echo "$VK_SDK_FINAL" | sed 's|\\|/|g')
          if [ -d "$VK_SDK_FINAL" ]; then
            echo "Final VULKAN_SDK: $VK_SDK_FINAL"
            echo "Contents:"
            ls -la "$VK_SDK_FINAL" | head -10 || true
            if [ -d "$VK_SDK_FINAL/Include" ] || [ -d "$VK_SDK_FINAL/include" ]; then
              echo "Vulkan SDK verification successful"
              # Ensure it's set for next steps
              echo "VULKAN_SDK=$VK_SDK_FINAL" >> $GITHUB_ENV
            else
              echo "Error: Include directory not found in $VK_SDK_FINAL"
              exit 1
            fi
          else
            echo "Error: VULKAN_SDK path does not exist: $VK_SDK_FINAL"
            exit 1
          fi
        else
          echo "Error: VULKAN_SDK is not set"
          exit 1
        fi
    
    - name: Install dependencies (Windows)
      if: matrix.os_name == 'windows'
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
    
    - name: Configure CMake
      shell: bash
      run: |
        # Debug: Print environment variables
        echo "VULKAN_SDK=$VULKAN_SDK"
        if [[ "${{ matrix.os_name }}" == "windows" ]]; then
          # On Windows, the action sets VULKAN_SDK in the environment
          # The action might set it in a different format, so check multiple sources
          if [ -z "$VULKAN_SDK" ]; then
            # Try reading from environment file if action uses it
            if [ -f "$GITHUB_ENV" ]; then
              source "$GITHUB_ENV" 2>/dev/null || true
            fi
          fi
          
          # Also check common Windows environment variable locations
          if [ -z "$VULKAN_SDK" ]; then
            # Try to find Vulkan SDK in common locations
            if [ -d "/c/VulkanSDK" ]; then
              VULKAN_SDK=$(find /c/VulkanSDK -maxdepth 1 -type d | grep -E "[0-9]+\.[0-9]+\.[0-9]+" | sort -V | tail -1 || true)
            elif [ -d "C:/VulkanSDK" ]; then
              VULKAN_SDK=$(find C:/VulkanSDK -maxdepth 1 -type d | grep -E "[0-9]+\.[0-9]+\.[0-9]+" | sort -V | tail -1 || true)
            fi
          fi
          
          if [ -n "$VULKAN_SDK" ]; then
            export VULKAN_SDK
            echo "VULKAN_SDK is set to: $VULKAN_SDK"
            
            # Convert to forward slashes for bash on Windows
            VULKAN_SDK=$(echo "$VULKAN_SDK" | sed 's|\\|/|g')
            export VULKAN_SDK
            
            # Verify the directory exists
            if [ -d "$VULKAN_SDK" ]; then
              echo "VULKAN_SDK directory exists"
              echo "Contents of VULKAN_SDK:"
              ls -la "$VULKAN_SDK" || true
              
              # Check for Include directory (case-insensitive on Windows)
              if [ -d "$VULKAN_SDK/Include" ] || [ -d "$VULKAN_SDK/include" ]; then
                echo "Found Include directory in $VULKAN_SDK"
              else
                echo "Include directory not found in $VULKAN_SDK, checking for versioned subdirectories..."
                # Look for versioned subdirectories
                VK_VERSIONED=$(find "$VULKAN_SDK" -maxdepth 1 -type d | grep -E "[0-9]+\.[0-9]+\.[0-9]+" | sort -V | tail -1 || true)
                if [ -n "$VK_VERSIONED" ] && [ -d "$VK_VERSIONED" ]; then
                  if [ -d "$VK_VERSIONED/Include" ] || [ -d "$VK_VERSIONED/include" ]; then
                    echo "Found Vulkan SDK in versioned subdirectory: $VK_VERSIONED"
                    VULKAN_SDK="$VK_VERSIONED"
                    export VULKAN_SDK
                  else
                    echo "Warning: Versioned directory found but no Include directory"
                    echo "Searching for include directories:"
                    find "$VULKAN_SDK" -maxdepth 3 -type d -iname "*include*" | head -5 || true
                  fi
                else
                  echo "Warning: Neither Include directory nor versioned subdirectory found"
                  echo "Searching for include directories:"
                  find "$VULKAN_SDK" -maxdepth 3 -type d -iname "*include*" | head -5 || true
                fi
              fi
              
              # Final check - if still no Include, error out
              if [ ! -d "$VULKAN_SDK/Include" ] && [ ! -d "$VULKAN_SDK/include" ]; then
                echo "Error: Could not find Vulkan SDK Include directory"
                echo "VULKAN_SDK is set to: $VULKAN_SDK"
                echo "Contents:"
                ls -la "$VULKAN_SDK" || true
                exit 1
              fi
            else
              echo "Error: VULKAN_SDK directory does not exist: $VULKAN_SDK"
              echo "Searching for Vulkan SDK in common locations:"
              find /c -maxdepth 3 -type d -iname "*vulkan*" 2>/dev/null | head -10 || true
              exit 1
            fi
          else
            echo "Error: VULKAN_SDK is not set and could not be found"
            echo "Environment variables:"
            env | grep -i vulkan || true
            exit 1
          fi
        fi
        
        if [[ "${{ matrix.os_name }}" == "macos" && "${{ matrix.arch }}" != "" ]]; then
          # On macOS, explicitly pass Vulkan SDK paths to CMake
          # The SDK structure is: VULKAN_SDK/include and VULKAN_SDK/lib
          VK_SDK="$VULKAN_SDK"
          VK_INCLUDE="$VK_SDK/include"
          
          echo "Using Vulkan SDK paths on macOS:"
          echo "  VULKAN_SDK: $VK_SDK"
          echo "  Include: $VK_INCLUDE"
          
          # Verify paths exist
          if [ ! -d "$VK_INCLUDE" ]; then
            echo "Error: Vulkan include directory not found: $VK_INCLUDE"
            echo "Contents of VULKAN_SDK ($VK_SDK):"
            ls -la "$VK_SDK" || true
            exit 1
          fi
          
          # Find the Vulkan library (could be libvulkan.dylib, libvulkan.1.dylib, etc.)
          VK_LIB=""
          if [ -d "$VK_SDK/lib" ]; then
            VK_LIB=$(find "$VK_SDK/lib" -name "libvulkan*.dylib" | head -1)
            if [ -n "$VK_LIB" ]; then
              echo "  Library: $VK_LIB"
            else
              echo "Warning: No Vulkan library found in $VK_SDK/lib"
              echo "Contents of lib directory:"
              ls -la "$VK_SDK/lib" || true
            fi
          fi
          
          # Build CMake command with explicit paths
          if [ -n "$VK_LIB" ]; then
            cmake -B build \
              -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
              -DVROOM_VERSION=${{ steps.version.outputs.VERSION }} \
              -DVROOM_BUILD_VROOM_EDITOR=ON \
              -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
              -DVULKAN_SDK="$VK_SDK" \
              -DVulkan_INCLUDE_DIR="$VK_INCLUDE" \
              -DVulkan_LIBRARY="$VK_LIB"
          else
            # Try without explicit library path - CMake should find it
            cmake -B build \
              -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
              -DVROOM_VERSION=${{ steps.version.outputs.VERSION }} \
              -DVROOM_BUILD_VROOM_EDITOR=ON \
              -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
              -DVULKAN_SDK="$VK_SDK" \
              -DVulkan_INCLUDE_DIR="$VK_INCLUDE"
          fi
        elif [[ "${{ matrix.os_name }}" == "windows" ]]; then
          # On Windows, explicitly pass VULKAN_SDK to CMake
          # Convert path separators if needed (bash on Windows might use /)
          # CMake handles both / and \ on Windows, but ensure paths are correct
          VK_SDK=$(echo "$VULKAN_SDK" | sed 's|\\|/|g')
          
          # Find Include directory (case-insensitive on Windows)
          VK_INCLUDE=""
          if [ -d "$VK_SDK/Include" ]; then
            VK_INCLUDE="$VK_SDK/Include"
          elif [ -d "$VK_SDK/include" ]; then
            VK_INCLUDE="$VK_SDK/include"
          else
            # Try to find it
            VK_INCLUDE=$(find "$VK_SDK" -maxdepth 2 -type d -iname "include" | head -1)
          fi
          
          # Find Lib directory and library file
          VK_LIB=""
          if [ -d "$VK_SDK/Lib" ]; then
            if [ -f "$VK_SDK/Lib/vulkan-1.lib" ]; then
              VK_LIB="$VK_SDK/Lib/vulkan-1.lib"
            elif [ -f "$VK_SDK/Lib/vulkan.lib" ]; then
              VK_LIB="$VK_SDK/Lib/vulkan.lib"
            else
              # Find any .lib file in Lib directory
              VK_LIB=$(find "$VK_SDK/Lib" -maxdepth 1 -name "vulkan*.lib" | head -1)
            fi
          elif [ -d "$VK_SDK/lib" ]; then
            if [ -f "$VK_SDK/lib/vulkan-1.lib" ]; then
              VK_LIB="$VK_SDK/lib/vulkan-1.lib"
            elif [ -f "$VK_SDK/lib/vulkan.lib" ]; then
              VK_LIB="$VK_SDK/lib/vulkan.lib"
            else
              VK_LIB=$(find "$VK_SDK/lib" -maxdepth 1 -name "vulkan*.lib" | head -1)
            fi
          else
            # Try to find lib directory
            LIB_DIR=$(find "$VK_SDK" -maxdepth 2 -type d -iname "lib" | head -1)
            if [ -n "$LIB_DIR" ]; then
              VK_LIB=$(find "$LIB_DIR" -maxdepth 1 -name "vulkan*.lib" | head -1)
            fi
          fi
          
          echo "Using Vulkan SDK paths on Windows:"
          echo "  VULKAN_SDK: $VK_SDK"
          echo "  Include: $VK_INCLUDE"
          echo "  Library: $VK_LIB"
          
          # Verify paths exist
          if [ -z "$VK_INCLUDE" ] || [ ! -d "$VK_INCLUDE" ]; then
            echo "Error: Vulkan include directory not found"
            echo "Searched in: $VK_SDK"
            exit 1
          fi
          
          if [ -z "$VK_LIB" ] || [ ! -f "$VK_LIB" ]; then
            echo "Warning: Vulkan library not found at expected location"
            echo "Searched for: $VK_SDK/Lib/vulkan-1.lib or $VK_SDK/lib/vulkan-1.lib"
            echo "CMake will try to find it automatically"
            # Don't pass library path, let CMake find it
            cmake -B build \
              -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
              -DVROOM_VERSION=${{ steps.version.outputs.VERSION }} \
              -DVROOM_BUILD_VROOM_EDITOR=ON \
              -DVULKAN_SDK="$VK_SDK" \
              -DVulkan_INCLUDE_DIR="$VK_INCLUDE"
          else
            cmake -B build \
              -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
              -DVROOM_VERSION=${{ steps.version.outputs.VERSION }} \
              -DVROOM_BUILD_VROOM_EDITOR=ON \
              -DVULKAN_SDK="$VK_SDK" \
              -DVulkan_INCLUDE_DIR="$VK_INCLUDE" \
              -DVulkan_LIBRARY="$VK_LIB"
          fi
        else
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DVROOM_VERSION=${{ steps.version.outputs.VERSION }} \
            -DVROOM_BUILD_VROOM_EDITOR=ON
        fi
    
    - name: Build
      run: |
        cmake --build build --config ${{ matrix.build_type }} -j${{ matrix.os_name == 'windows' && '4' || '$(nproc)' }}
    
    - name: Package (Linux)
      if: matrix.os_name == 'linux'
      run: |
        mkdir -p release
        cp build/vroom_editor/vroom_editor release/
        cp -r build/vroom_editor/assets release/ 2>/dev/null || true
        tar -czf vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.tar.gz -C release .
    
    - name: Package (macOS)
      if: matrix.os_name == 'macos'
      run: |
        mkdir -p release
        cp build/vroom_editor/vroom_editor release/vroom_editor
        cp -r build/vroom_editor/assets release/ 2>/dev/null || true
        tar -czf vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.tar.gz -C release .
    
    - name: Package (Windows)
      if: matrix.os_name == 'windows'
      run: |
        mkdir release
        copy build\vroom_editor\${{ matrix.build_type }}\vroom_editor.exe release\
        xcopy /E /I build\vroom_editor\${{ matrix.build_type }}\assets release\assets 2>nul || echo "No assets directory"
        powershell Compress-Archive -Path release\* -DestinationPath vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip
    
    - name: Determine artifact file
      id: artifact
      shell: bash
      run: |
        if [[ "${{ matrix.os_name }}" == "windows" ]]; then
          echo "FILE=vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip" >> $GITHUB_OUTPUT
        else
          echo "FILE=vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.tar.gz" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}
        path: ${{ steps.artifact.outputs.FILE }}
        retention-days: 90
    
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.artifact.outputs.FILE }}
        draft: false
        prerelease: ${{ contains(github.event.release.tag_name, 'alpha') || contains(github.event.release.tag_name, 'beta') || contains(github.event.release.tag_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
