name: Release Build

on:
  release:
    types: [created]

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            os_name: linux
            artifact_name: linux-x64
            build_type: Release
          - os: macos-15
            os_name: macos
            artifact_name: macos-x64
            build_type: Release
            arch: x86_64
          - os: macos-latest
            os_name: macos
            artifact_name: macos-arm64
            build_type: Release
            arch: arm64
          - os: windows-2022
            os_name: windows
            artifact_name: windows-x64
            build_type: Release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for version detection
    
    - name: Extract version from tag
      id: version
      run: |
        if [[ "${{ github.event.release.tag_name }}" != "" ]]; then
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
        elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
        else
          VERSION="0.0.0-dev"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Install dependencies (Linux)
      if: matrix.os_name == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libxext-dev \
          libxkbcommon-dev \
          libxkbcommon-x11-dev \
          libwayland-dev \
          wayland-protocols \
          extra-cmake-modules \
          libgl-dev \
          libglvnd-dev
    
    - name: Install Vulkan SDK (Linux)
      if: matrix.os_name == 'linux'
      run: |
        wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
        sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list
        sudo apt-get update
        sudo apt-get install -y \
          vulkan-tools \
          vulkan-validationlayers-dev \
          vulkan-headers \
          libvulkan-dev \
          libvulkan1
    
    - name: Install dependencies (macOS)
      if: matrix.os_name == 'macos'
      run: |
        brew install cmake
    
    - name: Install Vulkan SDK (macOS)
      if: matrix.os_name == 'macos'
      run: |
        brew install --cask vulkan-sdk
        export VULKAN_SDK=$(brew --prefix)/Cellar/vulkan-sdk/*/share/vulkan
        echo "VULKAN_SDK=$VULKAN_SDK" >> $GITHUB_ENV
    
    - name: Install dependencies (Windows)
      if: matrix.os_name == 'windows'
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
    
    - name: Install Vulkan SDK (Windows)
      if: matrix.os_name == 'windows'
      run: |
        $vulkanVersion = "1.3.280.0"
        $vulkanUrl = "https://sdk.lunarg.com/sdk/download/$vulkanVersion/windows/VulkanSDK-$vulkanVersion-Installer.exe"
        $installerPath = "$env:TEMP\VulkanSDK-Installer.exe"
        Write-Host "Downloading Vulkan SDK $vulkanVersion..."
        Invoke-WebRequest -Uri $vulkanUrl -OutFile $installerPath
        Write-Host "Installing Vulkan SDK..."
        Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait -NoNewWindow
        $vulkanPath = "${env:ProgramFiles}\VulkanSDK\$vulkanVersion"
        if (Test-Path $vulkanPath) {
          echo "VULKAN_SDK=$vulkanPath" >> $env:GITHUB_ENV
          echo "$vulkanPath\Bin" >> $env:GITHUB_PATH
          echo "$vulkanPath\Lib" >> $env:GITHUB_PATH
          echo "$vulkanPath\Include" >> $env:GITHUB_PATH
        } else {
          Write-Error "Vulkan SDK installation failed or path not found"
          exit 1
        }
    
    - name: Configure CMake
      shell: bash
      run: |
        if [[ "${{ matrix.os_name }}" == "macos" && "${{ matrix.arch }}" != "" ]]; then
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DVROOM_VERSION=${{ steps.version.outputs.VERSION }} \
            -DVROOM_BUILD_VROOM_EDITOR=ON \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }}
        else
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DVROOM_VERSION=${{ steps.version.outputs.VERSION }} \
            -DVROOM_BUILD_VROOM_EDITOR=ON
        fi
      env:
        VULKAN_SDK: ${{ env.VULKAN_SDK }}
    
    - name: Build
      run: |
        cmake --build build --config ${{ matrix.build_type }} -j${{ matrix.os_name == 'windows' && '4' || '$(nproc)' }}
    
    - name: Package (Linux)
      if: matrix.os_name == 'linux'
      run: |
        mkdir -p release
        cp build/vroom_editor/vroom_editor release/
        cp -r build/vroom_editor/assets release/ 2>/dev/null || true
        tar -czf vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.tar.gz -C release .
    
    - name: Package (macOS)
      if: matrix.os_name == 'macos'
      run: |
        mkdir -p release
        cp build/vroom_editor/vroom_editor release/vroom_editor
        cp -r build/vroom_editor/assets release/ 2>/dev/null || true
        tar -czf vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.tar.gz -C release .
    
    - name: Package (Windows)
      if: matrix.os_name == 'windows'
      run: |
        mkdir release
        copy build\vroom_editor\${{ matrix.build_type }}\vroom_editor.exe release\
        xcopy /E /I build\vroom_editor\${{ matrix.build_type }}\assets release\assets 2>nul || echo "No assets directory"
        powershell Compress-Archive -Path release\* -DestinationPath vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip
    
    - name: Determine artifact file
      id: artifact
      shell: bash
      run: |
        if [[ "${{ matrix.os_name }}" == "windows" ]]; then
          echo "FILE=vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip" >> $GITHUB_OUTPUT
        else
          echo "FILE=vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.tar.gz" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: vroom-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}
        path: ${{ steps.artifact.outputs.FILE }}
        retention-days: 90
    
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.artifact.outputs.FILE }}
        draft: false
        prerelease: ${{ contains(github.event.release.tag_name, 'alpha') || contains(github.event.release.tag_name, 'beta') || contains(github.event.release.tag_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
